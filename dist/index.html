<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Astro Party - Game Display</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        background: #000;
        font-family: "Arial", sans-serif;
        overflow: hidden;
        position: relative;
      }

      #gameContainer {
        position: relative;
        background: #0a0a1a;
        border: 2px solid #333;
        box-shadow: 0 0 50px rgba(100, 150, 255, 0.3);
      }

      #gameCanvas {
        display: block;
      }

      #info {
        position: absolute;
        top: 20px;
        left: 20px;
        color: #fff;
        font-size: 18px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 10px;
      }

      #status {
        position: absolute;
        top: 20px;
        right: 20px;
        color: #fff;
        font-size: 18px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 10px;
      }

      #startButton {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 20px 50px;
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        background: linear-gradient(
          135deg,
          rgba(46, 204, 113, 0.9),
          rgba(39, 174, 96, 0.9)
        );
        border: 3px solid rgba(255, 255, 255, 0.5);
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.2s;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        z-index: 10;
        display: none;
      }

      #startButton:hover {
        transform: translateX(-50%) scale(1.05);
        background: linear-gradient(
          135deg,
          rgba(46, 204, 113, 1),
          rgba(39, 174, 96, 1)
        );
      }

      #startButton:active {
        transform: translateX(-50%) scale(0.95);
      }

      #startButton:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .waiting {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-size: 24px;
        text-align: center;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div id="gameContainer">
      <canvas id="gameCanvas"></canvas>
      <div id="info">
        <div>Игроков: <span id="playerCount">0</span></div>
        <div>Выживших: <span id="aliveCount">0</span></div>
      </div>
      <div id="status">
        <div id="connectionStatus">Подключение...</div>
      </div>
      <button id="startButton">Начать игру</button>
      <div id="waiting" class="waiting" style="display: none">
        <h2>Ожидание игроков...</h2>
        <p>Откройте /control.html на устройстве управления</p>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const playerCountEl = document.getElementById("playerCount");
      const aliveCountEl = document.getElementById("aliveCount");
      const connectionStatusEl = document.getElementById("connectionStatus");
      const waitingEl = document.getElementById("waiting");
      const startButtonEl = document.getElementById("startButton");

      // Set canvas size
      canvas.width = 1920;
      canvas.height = 1080;

      // Scale canvas to fit screen
      function resizeCanvas() {
        const container = document.getElementById("gameContainer");
        const scale = Math.min(
          window.innerWidth / canvas.width,
          window.innerHeight / canvas.height
        );

        container.style.width = `${canvas.width}px`;
        container.style.height = `${canvas.height}px`;
        container.style.transform = `translate(-50%, -50%) scale(${scale})`;
        container.style.position = "absolute";
        container.style.left = "50%";
        container.style.top = "50%";
      }

      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      let gameState = {
        state: "lobby",
        hostId: null,
        players: [],
        bullets: [],
        results: [],
      };

      const ws = new WebSocket(`ws://${window.location.host}/display`);

      ws.onopen = () => {
        connectionStatusEl.textContent = "Подключено";
        connectionStatusEl.style.color = "#0f0";
      };

      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);

        if (message.type === "gameState") {
          gameState = message.data;
          playerCountEl.textContent = gameState.players.length;
          aliveCountEl.textContent = gameState.players.filter(
            (p) => p.alive && p.connected
          ).length;

          if (gameState.players.length === 0) {
            waitingEl.style.display = "block";
          } else {
            waitingEl.style.display = "none";
          }

          // Update status based on game state
          if (gameState.state === "lobby") {
            connectionStatusEl.textContent = "Лобби - ожидание игроков";
            // Show start button if enough players
            const connectedPlayers = gameState.players.filter(
              (p) => p.connected
            );
            if (connectedPlayers.length >= 2) {
              startButtonEl.style.display = "block";
            } else {
              startButtonEl.style.display = "none";
            }
          } else if (gameState.state === "playing") {
            connectionStatusEl.textContent = "Игра идет";
            startButtonEl.style.display = "none";
          } else if (gameState.state === "finished") {
            connectionStatusEl.textContent = "Раунд завершен";
            startButtonEl.style.display = "none";
          }
        }
      };

      ws.onerror = () => {
        connectionStatusEl.textContent = "Ошибка подключения";
        connectionStatusEl.style.color = "#f00";
      };

      ws.onclose = () => {
        connectionStatusEl.textContent = "Отключено";
        connectionStatusEl.style.color = "#f00";
      };

      // Draw stars background
      const stars = [];
      for (let i = 0; i < 200; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          size: Math.random() * 2,
          brightness: Math.random(),
        });
      }

      function drawStars() {
        ctx.save();
        ctx.imageSmoothingEnabled = false;
        ctx.fillStyle = "#fff";
        stars.forEach((star) => {
          ctx.globalAlpha = star.brightness;
          // Pixel-art звезды - квадраты
          const size = Math.max(1, Math.floor(star.size));
          ctx.fillRect(
            Math.floor(star.x) - size / 2,
            Math.floor(star.y) - size / 2,
            size,
            size
          );
        });
        ctx.globalAlpha = 1;
        ctx.restore();
      }

      function drawShip(x, y, angle, color, alive, name, connected) {
        const isDisconnected = connected === false;
        const displayColor = isDisconnected ? "#888888" : color;
        const shipSize = 30; // Размер корабля (длина от носа до хвоста)

        ctx.save();

        if (!alive || isDisconnected) {
          ctx.globalAlpha = isDisconnected ? 0.5 : 0.3;
        }

        ctx.translate(x, y);
        ctx.rotate(angle);

        // Pixel-art style: disable anti-aliasing
        ctx.imageSmoothingEnabled = false;

        // Ship body - треугольная форма (pixel-art)
        ctx.fillStyle = displayColor;
        ctx.beginPath();
        ctx.moveTo(shipSize, 0); // Нос корабля
        ctx.lineTo(-shipSize * 0.6, -shipSize * 0.5); // Левый угол
        ctx.lineTo(-shipSize * 0.3, 0); // Центр задней части
        ctx.lineTo(-shipSize * 0.6, shipSize * 0.5); // Правый угол
        ctx.closePath();
        ctx.fill();

        // Ship outline - белая обводка
        ctx.strokeStyle = isDisconnected ? "#666" : "#ffffff";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Engine glow (только если подключен)
        if (!isDisconnected && alive) {
          ctx.fillStyle = "#ffffff";
          ctx.globalAlpha = 0.8;
          // Два двигателя
          ctx.fillRect(-shipSize * 0.5, -shipSize * 0.2, 4, 4);
          ctx.fillRect(-shipSize * 0.5, shipSize * 0.2 - 4, 4, 4);
        }

        ctx.restore();
        ctx.globalAlpha = 1;
        ctx.imageSmoothingEnabled = true;

        // Draw player name below ship
        if (name) {
          ctx.save();
          ctx.globalAlpha = alive && connected !== false ? 1 : 0.5;
          ctx.fillStyle = isDisconnected ? "#888" : "#fff";
          ctx.font = "bold 14px monospace"; // Monospace для pixel-art стиля
          ctx.textAlign = "center";
          ctx.textBaseline = "top";

          // Draw text shadow/outline for better visibility
          ctx.strokeStyle = "#000";
          ctx.lineWidth = 3;
          ctx.strokeText(name, x, y + shipSize + 5);

          // Draw text
          ctx.fillText(name, x, y + shipSize + 5);
          ctx.restore();
        }
      }

      function drawBullet(x, y) {
        ctx.save();
        ctx.imageSmoothingEnabled = false;

        // Pixel-art пуля - квадрат
        ctx.fillStyle = "#ffff00";
        ctx.fillRect(x - 3, y - 3, 6, 6);

        // Обводка
        ctx.strokeStyle = "#ffaa00";
        ctx.lineWidth = 1;
        ctx.strokeRect(x - 3, y - 3, 6, 6);

        ctx.restore();
      }

      function gameLoop() {
        // Clear canvas
        ctx.fillStyle = "#0a0a1a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw stars
        drawStars();

        // Draw bullets
        gameState.bullets.forEach((bullet) => {
          drawBullet(bullet.x, bullet.y);
        });

        // Draw players
        // Draw players (only during playing state)
        if (gameState.state === "playing") {
          gameState.players.forEach((player) => {
            drawShip(
              player.x,
              player.y,
              player.angle,
              player.color,
              player.alive,
              player.name,
              player.connected
            );
          });
        }

        // Draw results overlay if finished
        if (gameState.state === "finished") {
          drawResults();
        }

        requestAnimationFrame(gameLoop);
      }

      // Draw results overlay
      function drawResults() {
        if (
          gameState.state !== "finished" ||
          !gameState.results ||
          gameState.results.length === 0
        )
          return;

        ctx.save();

        // Semi-transparent background
        ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Title
        ctx.fillStyle = "#fff";
        ctx.font = "bold 48px Arial";
        ctx.textAlign = "center";
        ctx.fillText("РЕЗУЛЬТАТЫ РАУНДА", canvas.width / 2, 150);

        // Results table
        const startY = 250;
        const rowHeight = 60;
        const headerY = startY;

        // Header
        ctx.font = "bold 24px Arial";
        ctx.fillText("Место", 200, headerY);
        ctx.fillText("Игрок", 500, headerY);
        ctx.fillText("Убийства", 900, headerY);
        ctx.fillText("Смерти", 1200, headerY);

        // Draw line
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(150, headerY + 20);
        ctx.lineTo(1400, headerY + 20);
        ctx.stroke();

        // Results
        gameState.results.forEach((result, index) => {
          const y = startY + 80 + index * rowHeight;
          const isWinner = index === 0 && result.alive;

          ctx.font = isWinner ? "bold 28px Arial" : "24px Arial";
          ctx.fillStyle = isWinner ? "#FFD700" : "#fff";

          // Place
          ctx.fillText(`#${index + 1}`, 200, y);

          // Name with color indicator
          ctx.fillStyle = result.color;
          ctx.fillRect(350, y - 20, 20, 20);
          ctx.fillStyle = isWinner ? "#FFD700" : "#fff";
          ctx.fillText(result.name, 500, y);

          // Kills
          ctx.fillText(result.kills.toString(), 900, y);

          // Deaths
          ctx.fillText(result.deaths.toString(), 1200, y);
        });

        // Footer
        ctx.fillStyle = "#888";
        ctx.font = "20px Arial";
        ctx.fillText(
          "Возврат в лобби через несколько секунд...",
          canvas.width / 2,
          canvas.height - 100
        );

        ctx.restore();
      }

      startButtonEl.addEventListener("click", () => {
        console.log("Start button clicked");
        console.log("WebSocket state:", ws ? ws.readyState : "ws not defined");
        if (ws && ws.readyState === WebSocket.OPEN) {
          console.log("Sending startGame message");
          ws.send(JSON.stringify({ type: "startGame" }));
        } else {
          console.error("Cannot send startGame: WebSocket not open");
        }
      });

      gameLoop();
    </script>
  </body>
</html>
